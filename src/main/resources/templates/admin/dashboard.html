<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      lang="en"
      layout:decorate="~{fragments/layout}">
<head>
    <title>Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"/>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root{
          --brand:#0ea5e9; --brand-2:#22c55e; --ink:#0f172a; --muted:#64748b;
          --panel:#ffffff; --bg:linear-gradient(180deg,#f8fafc 0%,#eff6ff 100%);
          --shadow:0 6px 24px rgba(2,6,23,.08); --radius:1.2rem;
        }
        body{ background:var(--bg); }
        .dashboard-header{ background:linear-gradient(90deg,#e7f7fa 65%,#f8fafc 100%);
          border-radius:var(--radius); box-shadow:var(--shadow); padding:1.1rem 1.2rem; margin-bottom:1.25rem; min-height:72px; }
        .dashboard-header h2{ color:var(--brand); letter-spacing:.3px; }
        .badge{ border-radius:999px; }

        .kpi .card{ border:0; background:var(--panel); border-radius:calc(var(--radius) - .3rem); box-shadow:var(--shadow); }
        .kpi .metric{ font-weight:800; letter-spacing:.2px; }

        .quick-access-row{ margin:0 -.5rem; }
        .quick-card{ display:flex; flex-direction:column; justify-content:center; align-items:center; border:0;
          background:linear-gradient(135deg,#f8fafc 80%,#e6f7fa 100%); border-radius:calc(var(--radius) - .2rem);
          padding:1.4rem 1rem 1.1rem; box-shadow:var(--shadow); min-height:120px; text-align:center;
          transition:.15s transform,.2s box-shadow; }
        .quick-card:hover{ transform:translateY(-2px) scale(1.02); box-shadow:0 12px 36px rgba(14,165,233,.2); text-decoration:none; }
        .quick-icon{ font-size:2rem; margin-bottom:.35rem; color:var(--brand-2); }
        .quick-title{ font-weight:700; color:var(--ink); }

        .chart-card{ border:0; background:var(--panel); border-radius:calc(var(--radius) - .3rem); box-shadow:var(--shadow); position:relative; }
        .chart-wrap{ height:300px; position:relative; }
        .chart-empty{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:.95rem; pointer-events:none; }

        .live-dot{
          width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:6px;
          background:#ef4444; box-shadow:0 0 0 rgba(239,68,68,.7); animation:pulse 1.5s infinite;
        }
        .live-dot.ok{ background:#22c55e; }
        @keyframes pulse {
          0% { box-shadow:0 0 0 0 rgba(239,68,68,.7); }
          70%{ box-shadow:0 0 0 6px rgba(239,68,68,0); }
          100%{ box-shadow:0 0 0 0 rgba(239,68,68,0); }
        }

        @media (max-width: 991px){ .chart-wrap{ height:260px; } }
        @media (max-width: 767px){
          .dashboard-header{ border-radius:.9rem; padding:.7rem .75rem; min-height:unset; }
          .quick-card{ min-height:92px; }
        }
    </style>
</head>
<body>
<section layout:fragment="content" class="container-fluid px-2 px-md-3 pb-4">

    <!-- Header -->
    <div class="dashboard-header d-flex align-items-center justify-content-between gap-3">
        <div class="d-flex align-items-center gap-3">
            <div>
                <h2 class="fw-bold mb-0">Dashboard</h2>
                <div class="small text-muted">Legha Krishi Farm ‚Äî Admin</div>
            </div>
        </div>
        <div><span class="badge bg-primary fs-6 py-2 px-3 d-none d-md-inline">üë§ Admin</span></div>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-3 kpi">
        <div class="col-6 col-md-4 col-xl-2">
            <div class="card p-3 text-center">
                <div class="text-muted small mb-1">Total Partners</div>
                <div class="metric fs-3 text-success" th:text="${partnerCount}">0</div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-xl-2">
            <div class="card p-3 text-center">
                <div class="text-muted small mb-1">Income (Paid Bills)</div>
                <div class="metric fs-4" th:text="${#numbers.formatDecimal(totalIncomeReceived,1,'COMMA',2,'POINT')}">0.00</div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-xl-2">
            <div class="card p-3 text-center">
                <div class="text-muted small mb-1">Other Income</div>
                <div class="metric fs-4" th:text="${#numbers.formatDecimal(otherIncome,1,'COMMA',2,'POINT')}">‚Çπ0.00</div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-xl-2">
            <div class="card p-3 text-center">
                <div class="text-muted small mb-1">Govt Deductions</div>
                <div class="metric fs-4" th:text="${#numbers.formatDecimal(totalGovernmentDeductions,1,'COMMA',2,'POINT')}">‚Çπ0.00</div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-xl-2">
            <div class="card p-3 text-center">
                <div class="text-muted small mb-1">Total Outgoing</div>
                <div class="metric fs-4" th:text="${#numbers.formatDecimal(totalOutgoing,1,'COMMA',2,'POINT')}">‚Çπ0.00</div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-xl-2">
            <div class="card p-3 text-center">
                <div class="text-muted small mb-1">Balance</div>
                <div class="metric fs-4" th:text="${#numbers.formatDecimal(balanceAmount,1,'COMMA',2,'POINT')}">‚Çπ0.00</div>
            </div>
        </div>
    </div>

    <!-- Last Meter Reading -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card chart-card p-3">
                <div class="text-muted small mb-2">Last Meter Reading</div>

                <div th:if="${lastReading != null}">
                    <div class="row">
                        <div class="col-12 col-md-4 mb-2"><b>Plant:</b> <span th:text="${lastReading.plantName}"></span></div>
                        <div class="col-6 col-md-4 mb-2"><b>Date:</b> <span th:text="${#temporals.format(lastReading.readingDate,'dd/MM/yyyy')}"></span></div>
                        <div class="col-6 col-md-4 mb-2"><b>Month/Year:</b> <span th:text="${lastReading.month + ' / ' + lastReading.year}"></span></div>
                    </div>
                    <hr class="my-2">
                    <div class="row">
                        <div class="col-12 col-lg-6">
                            <h6 class="mb-2">Main Meter</h6>
                            <ul class="list-unstyled mb-0 small">
                                <li><b>Meter:</b> <span th:text="${mainMeter.meterName}"></span></li>
                                <li><b>Import Start:</b> <span th:text="${mainMeter.kwhImportStart}"></span></li>
                                <li><b>Import End:</b> <span th:text="${mainMeter.kwhImportEnd}"></span></li>
                                <li><b>Export Start:</b> <span th:text="${mainMeter.kwhExportStart}"></span></li>
                                <li><b>Export End:</b> <span th:text="${mainMeter.kwhExportEnd}"></span></li>
                            </ul>
                        </div>
                        <div class="col-12 col-lg-6">
                            <h6 class="mb-2">Check Meter</h6>
                            <ul class="list-unstyled mb-0 small">
                                <li><b>Meter:</b> <span th:text="${checkMeter.meterName}"></span></li>
                                <li><b>Import Start:</b> <span th:text="${checkMeter.kwhImportStart}"></span></li>
                                <li><b>Import End:</b> <span th:text="${checkMeter.kwhImportEnd}"></span></li>
                                <li><b>Export Start:</b> <span th:text="${checkMeter.kwhExportStart}"></span></li>
                                <li><b>Export End:</b> <span th:text="${checkMeter.kwhExportEnd}"></span></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div th:if="${lastReading == null}" class="text-muted">No Last Meter Reading Available.</div>

                <div class="mt-2">
                    <a th:href="@{/admin/jmr_reports}" class="btn btn-sm btn-outline-primary">View All Readings</a>
                    <a th:href="@{/admin/jmr_reports/add}" class="btn btn-sm btn-success ms-2">Add JMR</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Intraday Power (3 meters) -->
    <div class="card chart-card mb-3">
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
                <h6 class="card-title mb-0"><i class="bi bi-lightning-charge me-2"></i> Live Power ‚Äî MAIN / STANDBY / CHECK (kW)</h6>
                <span id="liveStatus" class="badge bg-light text-dark"><span class="live-dot" id="liveDot"></span>connecting‚Ä¶</span>
            </div>
            <div class="chart-wrap">
                <canvas id="liveChartAdmin"></canvas>
            </div>
        </div>
    </div>

    <!-- Meter-wise Daily Charts -->
    <section class="container-fluid my-4 px-0" id="energy-charts" th:with="siteId=${defaultSiteId}">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h5 class="mb-0">Energy &amp; Power ‚Äî Meter-wise</h5>
            <div class="d-flex gap-2 align-items-center">
                <select id="siteSelect" class="form-select form-select-sm" style="min-width:220px" th:disabled="${#lists.isEmpty(sites)}">
                    <option th:each="s : ${sites}" th:value="${s.id}"
                            th:text="${s.name} + ' (ID: ' + ${s.id} + ')'"
                            th:selected="${s.id == defaultSiteId}"></option>
                </select>
                <select id="daysSelect" class="form-select form-select-sm" style="width:120px">
                    <option value="7">Last 7 days</option>
                    <option value="14">Last 14 days</option>
                    <option value="30" selected>Last 30 days</option>
                </select>
                <button id="refreshBtn" class="btn btn-sm btn-primary">Refresh</button>
            </div>
        </div>

        <div class="row g-3">
            <div class="col-12 col-lg-6">
                <div class="card chart-card">
                    <div class="card-body chart-wrap">
                        <h6 class="card-title mb-2">Daily AC Active Energy (kWh)</h6>
                        <canvas id="chAcDaily"></canvas>
                        <div id="empty-acdaily" class="chart-empty" style="display:none;">No data</div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-6">
                <div class="card chart-card">
                    <div class="card-body chart-wrap">
                        <h6 class="card-title mb-2">Daily AC Export Energy (kWh)</h6>
                        <canvas id="chAcExportDaily"></canvas>
                        <div id="empty-acexport" class="chart-empty" style="display:none;">No data</div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-6">
                <div class="card chart-card">
                    <div class="card-body chart-wrap">
                        <h6 class="card-title mb-2">Daily AC Import Energy (kWh)</h6>
                        <canvas id="chAcImportDaily"></canvas>
                        <div id="empty-acimport" class="chart-empty" style="display:none;">No data</div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-6">
                <div class="card chart-card">
                    <div class="card-body chart-wrap">
                        <h6 class="card-title mb-2">Daily DC Energy (kWh)</h6>
                        <canvas id="chDcDaily"></canvas>
                        <div id="empty-dcdaily" class="chart-empty" style="display:none;">No data</div>
                    </div>
                </div>
            </div>

            <div class="col-12">
                <div class="card chart-card">
                    <div class="card-body chart-wrap">
                        <h6 class="card-title mb-2">Max AC Power (kW)</h6>
                        <canvas id="chMaxPower"></canvas>
                        <div id="empty-maxp" class="chart-empty" style="display:none;">No data</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- RMS Summary & Health -->
    <div class="row g-3 mb-3" id="rmsRow">
        <!-- Performance KPIs -->
        <div class="col-12 col-xl-8">
            <div class="card p-3 chart-card">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Plant Performance</h6>
                    <div class="small text-muted" id="rmsLastUpdated">‚Äî</div>
                </div>
                <div class="row g-3 text-center">
                    <div class="col-6 col-md-4 col-xl-2">
                        <div class="border rounded-3 p-2">
                            <div class="small text-muted">PR</div>
                            <div class="fs-4 fw-bold" id="kpiPR">‚Äî</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-xl-2">
                        <div class="border rounded-3 p-2">
                            <div class="small text-muted">CUF</div>
                            <div class="fs-4 fw-bold" id="kpiCUF">‚Äî</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-xl-2">
                        <div class="border rounded-3 p-2">
                            <div class="small text-muted">Energy Today</div>
                            <div class="fs-5 fw-bold" id="kpiEToday">‚Äî</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-xl-2">
                        <div class="border rounded-3 p-2">
                            <div class="small text-muted">Energy MTD</div>
                            <div class="fs-5 fw-bold" id="kpiEMtd">‚Äî</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-xl-2">
                        <div class="border rounded-3 p-2">
                            <div class="small text-muted">Availability</div>
                            <div class="fs-5 fw-bold" id="kpiAvail">‚Äî</div>
                        </div>
                    </div>
                </div>
                <!-- Latency banner -->
                <div id="telemetryBanner" class="alert alert-warning py-2 px-3 mt-3 d-none">
                    <span class="me-2">‚ö†Ô∏è</span> Telemetry stale: last packet <span id="lastPacketAge">‚Äî</span> ago
                </div>
            </div>
        </div>

        <!-- Fleet health & alarms -->
        <div class="col-12 col-xl-4">
            <div class="card p-3 chart-card mb-3">
                <h6 class="mb-2">Fleet Health</h6>
                <div class="d-flex flex-wrap gap-2">
                    <span class="badge bg-success px-3 py-2 rounded-pill">Online: <span id="devOn">‚Äî</span></span>
                    <span class="badge bg-secondary px-3 py-2 rounded-pill">Offline: <span id="devOff">‚Äî</span></span>
                    <span class="badge bg-danger px-3 py-2 rounded-pill">Open Alerts: <span id="alertsOpen">‚Äî</span></span>
                    <span class="badge bg-info text-dark px-3 py-2 rounded-pill">Last Data: <span id="lastPkt">‚Äî</span></span>
                </div>
            </div>

            <div class="card p-0 chart-card">
                <div class="p-3 pb-0 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Active Alarms</h6>
                    <a th:href="@{/admin/alarms}" class="small">View all</a>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead class="table-light">
                        <tr>
                            <th style="width:34%">Time</th>
                            <th style="width:26%">Device</th>
                            <th style="width:14%">Level</th>
                            <th>Title</th>
                        </tr>
                        </thead>
                        <tbody id="alarmsBody">
                        <tr><td colspan="4" class="text-muted small text-center py-3">No alarms</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ====== Server values for JS ====== -->
    <script th:inline="javascript">
        const DEFAULT_SITE_ID = /*[[${defaultSiteId}]]*/ 1;
    </script>

    <!-- ====== Live streaming scripts ====== -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <!-- Live 3-meter chart (prefill + STOMP) -->
    <script>
        (() => {
          const statusEl = document.getElementById('liveStatus');
          const dot = document.getElementById('liveDot');
          const ctx = document.getElementById('liveChartAdmin')?.getContext('2d');
          const siteSel = document.getElementById('siteSelect');

          const labels=[], main=[], standby=[], check=[];
          const chart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [
              { label:'MAIN (kW)',    data:main,    fill:false, tension:0.25 },
              { label:'STANDBY (kW)', data:standby, fill:false, tension:0.25 },
              { label:'CHECK (kW)',   data:check,   fill:false, tension:0.25 }
            ]},
            options: {
              animation:false, responsive:true,
              scales:{ y:{ beginAtZero:true }, x:{ ticks:{ maxTicksLimit:12 } } },
              plugins:{ legend:{ position:'bottom' } }
            }
          });

          function upsert(label, a,b,c){
            const last = labels.length ? labels[labels.length-1] : null;
            if (last===label){
              main[main.length-1]=a; standby[standby.length-1]=b; check[check.length-1]=c;
            } else {
              labels.push(label); main.push(a); standby.push(b); check.push(c);
              if (labels.length>96){ labels.shift(); main.shift(); standby.shift(); check.shift(); }
            }
            chart.update('none');
          }

          async function prefill(siteId){
            const d=new Date(), yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
            const url = `/admin/charts/intraday?siteId=${encodeURIComponent(siteId)}&day=${yyyy}-${mm}-${dd}&metric=TOTAL_AC_POWER&stepMin=15`;
            try{
              const r=await fetch(url,{credentials:'include', cache:'no-store'});
              if(!r.ok) throw new Error(r.statusText);
              const j=await r.json();
              const s=j.series||{}, L=(j.labels||[]).length;
              labels.length=0; labels.push(...(j.labels||[]));
              main.length=0; standby.length=0; check.length=0;
              main.push(...((s.MAIN||[]).slice(0,L)));
              standby.push(...((s.STANDBY||[]).slice(0,L)));
              check.push(...((s.CHECK||[]).slice(0,L)));
              chart.update('none');
              statusEl.textContent='history prefilled‚Ä¶';
              if (dot) dot.classList.add('ok');
            }catch(e){
              statusEl.textContent='prefill error';
              if (dot) dot.classList.remove('ok');
            }
          }

          let client=null, sub=null;
          function subscribe(siteId){
            if (!client) return;
            if (sub) { sub.unsubscribe(); sub=null; }
            sub = client.subscribe(`/topic/intraday/${siteId}`, msg=>{
              const t=JSON.parse(msg.body), s=t.series||{};
              upsert(t.label, Number(s.MAIN||0), Number(s.STANDBY||0), Number(s.CHECK||0));
            });
            statusEl.textContent = `live: site ${siteId}`;
            if (dot) dot.classList.add('ok');
          }

          function connectThen(siteId){
            if (client) { subscribe(siteId); return; }
            const sock = new SockJS('/ws'); client = Stomp.over(sock); client.debug=null;
            client.connect({}, ()=>{ statusEl.textContent='connected'; subscribe(siteId); },
                                ()=>{ statusEl.textContent='connect error'; if(dot) dot.classList.remove('ok'); });
          }

          function currentSiteId(){
            const v = siteSel?.value || DEFAULT_SITE_ID || 1;
            return String(v);
          }

          // bootstrap
          const sid = currentSiteId();
          prefill(sid).then(()=>connectThen(sid));
          siteSel?.addEventListener('change', ()=>{
            const sid = currentSiteId();
            prefill(sid).then(()=>subscribe(sid));
          });
        })();
    </script>

    <!-- Daily meter-wise charts (5-min refresh + demo fallback) -->
    <script>
        (() => {
          const $site = document.getElementById('siteSelect');
          const $days = document.getElementById('daysSelect');
          const $btn  = document.getElementById('refreshBtn');

          const endpoints = {
            adminSeries: (siteId, days) => `/admin/charts/day-meter-series?siteId=${siteId}&days=${days}`,
            labels: (siteId) => `/admin/charts/meter-labels?siteId=${siteId}`
          };

          let charts = {
            chAcDaily: null,
            chAcExportDaily: null,
            chAcImportDaily: null,
            chDcDaily: null,
            chMaxPower: null
          };

          const meterOrder = ['MAIN','STANDBY','CHECK'];
          const meterColors = {
            MAIN:'rgba(54,162,235,0.9)',
            STANDBY:'rgba(255,159,64,0.9)',
            CHECK:'rgba(75,192,192,0.9)'
          };
          let meterLabels = { MAIN:'MAIN', STANDBY:'STANDBY', CHECK:'CHECK' };

          async function loadLabels(siteId){
            try{
              const res = await fetch(endpoints.labels(siteId), { cache:'no-store' });
              if (res.ok) meterLabels = await res.json();
            }catch(e){ console.warn('meter-labels fetch failed:', e); }
          }

          const findKey = (obj, regexes) => {
            if (!obj) return null;
            const keys = Object.keys(obj);
            for (const rx of regexes) {
              const k = keys.find(k => rx.test(k));
              if (k) return k;
            }
            return null;
          };

          function resolveMetricKeys(seriesObj){
            return {
              acActiveEnergyKwh: findKey(seriesObj, [/ac.*active.*energy.*kwh/i, /daily.*ac.*energy/i, /ac.*energy.*day/i, /ac.*energy/i]),
              acExportEnergyKwh: findKey(seriesObj, [/ac.*export.*energy.*kwh/i, /daily.*ac.*export/i, /export.*energy/i]),
              acImportEnergyKwh: findKey(seriesObj, [/ac.*import.*energy.*kwh/i, /daily.*ac.*import/i, /import.*energy/i]),
              dcEnergyKwh:       findKey(seriesObj, [/dc.*energy.*kwh/i, /daily.*dc.*energy/i, /dc.*energy/i]),
              maxAcPowerKw:      findKey(seriesObj, [/max.*ac.*power.*kw/i, /ac.*max.*power/i, /max.*power/i])
            };
          }

          function toDatasets(metricKey, series){
            const src = metricKey && series?.[metricKey] ? series[metricKey] : {};
            return meterOrder.map(m => ({
              label: meterLabels[m] || m,
              data: src[m] || [],
              borderColor: meterColors[m],
              backgroundColor: meterColors[m],
              tension: .25,
              pointRadius: 0,
              borderWidth: 2
            }));
          }

          function bumpAllZeroDatasets(datasets, unitKey){
            const EPS = unitKey === 'kW' ? 0.01 : 0.05;
            const allValues = datasets.flatMap(d => d.data || []).map(v => Number(v || 0));
            const maxVal = allValues.reduce((m,v)=> Math.max(m, v), 0);
            if (maxVal === 0) {
              datasets.forEach(d => {
                d.data = (d.data || []).map(v => v == null ? null : (Number(v) === 0 ? EPS : Number(v)));
              });
              return {suggestedMin: 0, suggestedMax: EPS * 3};
            }
            return {suggestedMin: 0, suggestedMax: Math.max(maxVal * 1.2, 1)};
          }

          function makeConfig(labels, datasets, yTitle, yRange){
            return {
              type:'line',
              data:{ labels, datasets },
              options:{
                responsive:true,
                maintainAspectRatio:false,
                interaction:{ mode:'index', intersect:false },
                plugins:{ legend:{ position:'bottom' } },
                scales:{
                  x:{ ticks:{ autoSkip:true, maxTicksLimit:12 } },
                  y:{ beginAtZero:true, title:{ display:true, text:yTitle }, ...(yRange||{}) }
                }
              }
            };
          }

          function upsertChart(instance, canvasId, config){
            const canvas = document.getElementById(canvasId);
            if (!canvas) return instance;
            const ctx = canvas.getContext('2d');
            if (instance) instance.destroy();
            return new Chart(ctx, config);
          }

          const setEmpty = (id, on) => { const el = document.getElementById(id); if (el) el.style.display = on ? 'flex' : 'none'; };

          function renderAll(labels, series){
            const hasLabels = Array.isArray(labels) && labels.length > 0;
            setEmpty('empty-acdaily',  !hasLabels);
            setEmpty('empty-acexport', !hasLabels);
            setEmpty('empty-acimport', !hasLabels);
            setEmpty('empty-dcdaily',  !hasLabels);
            setEmpty('empty-maxp',     !hasLabels);

            const keys = resolveMetricKeys(series);

            // AC Active Energy (kWh)
            { const ds = toDatasets(keys.acActiveEnergyKwh, series);
              const y  = bumpAllZeroDatasets(ds, 'kWh');
              charts.chAcDaily = upsertChart(charts.chAcDaily, 'chAcDaily', makeConfig(labels, ds, 'kWh', y)); }

            // AC Export Energy (kWh)
            { const ds = toDatasets(keys.acExportEnergyKwh, series);
              const y  = bumpAllZeroDatasets(ds, 'kWh');
              charts.chAcExportDaily = upsertChart(charts.chAcExportDaily, 'chAcExportDaily', makeConfig(labels, ds, 'kWh', y)); }

            // AC Import Energy (kWh)
            { const ds = toDatasets(keys.acImportEnergyKwh, series);
              const y  = bumpAllZeroDatasets(ds, 'kWh');
              charts.chAcImportDaily = upsertChart(charts.chAcImportDaily, 'chAcImportDaily', makeConfig(labels, ds, 'kWh', y)); }

            // DC Energy (kWh)
            { const ds = toDatasets(keys.dcEnergyKwh, series);
              const y  = bumpAllZeroDatasets(ds, 'kWh');
              charts.chDcDaily = upsertChart(charts.chDcDaily, 'chDcDaily', makeConfig(labels, ds, 'kWh', y)); }

            // Max AC Power (kW)
            { const ds = toDatasets(keys.maxAcPowerKw, series);
              const y  = bumpAllZeroDatasets(ds, 'kW');
              charts.chMaxPower = upsertChart(charts.chMaxPower, 'chMaxPower', makeConfig(labels, ds, 'kW', y)); }
          }

          async function loadAndRender(){
            const siteId = $site?.value ?? '';
            const days   = $days?.value ?? '30';
            if (!siteId) return;
            try{
              await loadLabels(siteId);
              const res = await fetch(endpoints.adminSeries(siteId, days), { cache:'no-store' });
              if (!res.ok) throw new Error(res.statusText);
              const data = await res.json();
              renderAll(data.labels || [], data.series || {});
            }catch(e){
              console.error('day-meter-series load error:', e);
              renderAll([], {});
            }
          }

          $btn ?.addEventListener('click', loadAndRender);
          $site?.addEventListener('change', loadAndRender);
          $days?.addEventListener('change', loadAndRender);

          loadAndRender(); // initial
        })();
    </script>

    <!-- RMS summary fetchers -->
    <script>
        (() => {
          const $siteSelect = document.getElementById('siteSelect');
          const siteId = () => ($siteSelect?.value || DEFAULT_SITE_ID || 1).toString();
          const fmtPct = v => (v==null ? '‚Äî' : (Number(v).toFixed(1)+'%'));
          const fmtKwh = v => (v==null ? '‚Äî' : Number(v).toLocaleString(undefined,{maximumFractionDigits:1})+' kWh');

          const el = id => document.getElementById(id);
          function set(elm, text){ if (elm) elm.textContent = text; }
          function show(elm, on){ if (elm) elm.classList.toggle('d-none', !on); }

          function ageFrom(iso){
            if (!iso) return {txt:'‚Äî', ms:Infinity};
            const t = new Date(iso).getTime();
            if (!t) return {txt:'‚Äî', ms:Infinity};
            const ms = Date.now() - t;
            const min = Math.floor(ms/60000);
            if (min < 60) return {txt:`${min} min`, ms};
            const h = Math.floor(min/60), m = min%60;
            return {txt:`${h}h ${m}m`, ms};
          }

          async function getJson(url){
            try{
              const r = await fetch(url, {cache:'no-store', credentials:'same-origin'});
              if (!r.ok) throw new Error(r.statusText);
              const ct = r.headers.get('content-type')||'';
              if (!ct.includes('application/json')) throw new Error('NOT_JSON');
              return await r.json();
            }catch(e){ return null; }
          }

          async function loadRms(){
            const sid = siteId();
            if (!sid) return;

            // 1) Performance summary
            const sum = await getJson(`/admin/rms/summary?siteId=${encodeURIComponent(sid)}`);
            set(el('kpiPR'),    sum ? fmtPct(sum.pr) : '‚Äî');
            set(el('kpiCUF'),   sum ? fmtPct(sum.cuf) : '‚Äî');
            set(el('kpiEToday'),sum ? fmtKwh(sum.energyTodayKwh) : '‚Äî');
            set(el('kpiEMtd'),  sum ? fmtKwh(sum.energyMtdKwh) : '‚Äî');
            set(el('kpiAvail'), sum ? fmtPct(sum.availability) : '‚Äî');
            set(el('rmsLastUpdated'), sum?.updatedAtIso ? new Date(sum.updatedAtIso).toLocaleString() : '‚Äî');

            // 2) Devices status
            const stat = await getJson(`/admin/rms/devices/status?siteId=${encodeURIComponent(sid)}`);
            set(el('devOn'),      stat?.online ?? '‚Äî');
            set(el('devOff'),     stat?.offline ?? '‚Äî');
            const age = ageFrom(stat?.lastPacketIso);
            set(el('lastPkt'), age.txt);
            set(el('alertsOpen'), stat?.alertsOpen ?? '‚Äî');

            // Latency banner if last packet older than 15 minutes
            show(el('telemetryBanner'), age.ms > 15*60*1000);
            set(el('lastPacketAge'), age.txt);

            // 3) Active alarms
            const alarms = await getJson(`/admin/rms/alarms?siteId=${encodeURIComponent(sid)}&limit=5`);
            const $body = el('alarmsBody');
            if ($body){
              $body.innerHTML = '';
              const list = Array.isArray(alarms) ? alarms : [];
              if (list.length === 0){
                $body.innerHTML = '<tr><td colspan="4" class="text-muted small text-center py-3">No alarms</td></tr>';
              } else {
                list.forEach(a => {
                  const tr = document.createElement('tr');
                  const sev = (a.severity||'').toUpperCase();
                  const sevClass =
                    sev === 'CRITICAL' ? 'badge bg-danger' :
                    sev === 'MAJOR'    ? 'badge bg-warning text-dark' :
                    'badge bg-secondary';
                  tr.innerHTML = `
                    <td class="small">${a.timeIso ? new Date(a.timeIso).toLocaleString() : '‚Äî'}</td>
                    <td class="small">${a.device || '‚Äî'}</td>
                    <td><span class="${sevClass}">${sev||'‚Äî'}</span></td>
                    <td class="small">${a.title || '‚Äî'}</td>`;
                  $body.appendChild(tr);
                });
              }
            }
          }

          // Run now & when site changes
          loadRms();
          $siteSelect?.addEventListener('change', loadRms);
        })();
    </script>

</section>
</body>
</html>
